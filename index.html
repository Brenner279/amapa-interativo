<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Amapa Interativo: Com Loading</title>
  
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
  
  <script>
    /* --- CONFIGURAÇÃO E DADOS --- */
    
    const db = {
      'vitoria': {
        nome: 'Vitoria do Jari',
        bandeira: './assets/imagens/bandeiras/vitoria.png', 
        conteudos: {
          'Historia': { 
             t: 'Historia', 
             video: './assets/videos/vitoria.mp4', 
             tipo: 'video360' 
          },
          'Cultura': { t: 'Cultura', txt: 'Olhe para o PLAY', narra: './assets/audios/vitoria.mp3', tipo: 'audio' },
          'Turismo': { t: 'Turismo', txt: 'Turismo Local', imagemPainel: './assets/imagens/vitoria.png', tipo: 'imagem' }
        }
      },
      'macapa': { nome: 'Macapa', bandeira: './assets/imagens/bandeiras/macapa.png', conteudos: {} },
      'laranjal do jari': { nome: 'Laranjal do Jari', bandeira: './assets/imagens/bandeiras/laranjal.png', conteudos: {} },
      'oiapoque': { nome: 'Oiapoque', bandeira: './assets/imagens/bandeiras/oiapoque.png', conteudos: {} },
      'serra do navio': { nome: 'Serra do Navio', bandeira: './assets/imagens/bandeiras/serra.png', conteudos: {} },
      'santana': { nome: 'Santana', bandeira: './assets/imagens/bandeiras/santana.png', conteudos: {} },
      'amapa': { nome: 'Amapa', bandeira: './assets/imagens/bandeiras/amapa.png', conteudos: {} },
    };

    let cidadeAtual = '';
    let audioNarracao = null;

    window.onload = function() {
      gerarMenuCidades();
      setupVideoEvents(); // Nova função para configurar eventos do vídeo
    };

    function gerarMenuCidades() {
      const container = document.getElementById('grade-cidades');
      const chaves = Object.keys(db);
      let col = 0; let row = 0; const chavesPorLinha = 3; 

      chaves.forEach((chave) => {
        const cidade = db[chave];
        const x = (col * 1.3) - 1.3; 
        const y = 0.8 - (row * 1.0); 
        const el = document.createElement('a-entity');
        el.setAttribute('position', `${x} ${y} 0`);
        
        // Se a imagem não existir, usa cor sólida
        const imagemSrc = cidade.bandeira ? `src="${cidade.bandeira}"` : 'color="#999"';

        el.innerHTML = `
          <a-plane
            ${imagemSrc} width="1" height="0.7" class="clicavel interativo"
            onclick="selecionarCidade('${chave}')" material="shader: flat"
            animation__scale="property: scale; to: 1.1 1.1 1.1; dur: 200; startEvents: mouseenter"
            animation__out="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
          </a-plane>
          <a-text value="${cidade.nome}" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 -0.5 0" width="3.5" color="#FFFFFF" shader="msdf"></a-text>
        `;
        container.appendChild(el);
        col++; if (col >= chavesPorLinha) { col = 0; row++; }
      });
    }

    /* --- SETUP DE EVENTOS DE VIDEO (LOADING) --- */
    function setupVideoEvents() {
        const video = document.getElementById('video-player');
        const loader = document.getElementById('loader-360');
        const controles = document.getElementById('controle-360-gaze');
        
        const botao = document.getElementById('btnPlay360');
        const texto = document.getElementById('btnText360');

        // Botão de Play/Pause (Gaze)
        botao.addEventListener('click', function() {
            if (video.paused) {
                video.play();
                botao.setAttribute('color', '#333'); 
                texto.setAttribute('value', 'OLHE PARA PAUSAR');
            } else {
                video.pause();
                botao.setAttribute('color', '#EF2D5E');
                texto.setAttribute('value', 'OLHE PARA TOCAR');
            }
        });

        // Evento: Quando o video começar a tocar de verdade
        video.addEventListener('playing', () => {
            // Esconde o Loading
            loader.setAttribute('visible', 'false');
            // Mostra os controles
            controles.setAttribute('visible', 'true');
            // Atualiza estado do botão
            botao.setAttribute('color', '#333'); 
            texto.setAttribute('value', 'OLHE PARA PAUSAR');
        });

        // Evento: Se o video travar para carregar (buffer)
        video.addEventListener('waiting', () => {
            loader.setAttribute('visible', 'true');
        });
    }

    function irPara(idGrupo) {
      ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'].forEach(g => {
        const el = document.getElementById(g);
        el.setAttribute('visible', 'false');
        el.querySelectorAll('.interativo').forEach(b => b.classList.remove('clicavel'));
      });

      desativarModo360();

      const destino = document.getElementById(idGrupo);
      destino.setAttribute('visible', 'true');
      destino.querySelectorAll('.interativo').forEach(b => b.classList.add('clicavel'));
      
      atualizarAmbiente(idGrupo);
      if(idGrupo !== 'grupo-player') pararTudo();
    }

    function selecionarCidade(chave) {
      cidadeAtual = chave;
      document.getElementById('titulo-cidade-cat').setAttribute('value', db[chave].nome);
      irPara('grupo-categorias');
    }

    function verConteudo(tipo) {
      if(!db[cidadeAtual].conteudos[tipo]) return;
      const dados = db[cidadeAtual].conteudos[tipo];
      pararTudo();

      if (dados.tipo === 'video360') {
          ativarModo360(dados.video);
          return;
      }

      // Player 2D
      const controles = document.getElementById('controles-media');
      const tela = document.getElementById('vr-video-screen');
      const img = document.getElementById('vr-imagem-screen');
      tela.setAttribute('visible', 'false');
      img.setAttribute('visible', 'false');
      controles.setAttribute('visible', 'false');
      document.getElementById('vr-titulo').setAttribute('value', dados.t);
      
      if (dados.tipo === 'audio' && dados.narra) {
         audioNarracao = new Audio(dados.narra);
         controles.setAttribute('visible', 'true');
         controles.querySelectorAll('.interativo').forEach(b => b.classList.add('clicavel'));
      } else if (dados.tipo === 'imagem') {
         img.setAttribute('src', dados.imagemPainel);
         img.setAttribute('visible', 'true');
      }
      irPara('grupo-player');
    }

    function ativarModo360(videoSrc) {
        ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'].forEach(id => {
            document.getElementById(id).setAttribute('visible', 'false');
        });
        document.getElementById('ambiente-3d').removeAttribute('environment');

        const videoEl = document.getElementById('video-player');
        videoEl.setAttribute('src', videoSrc);

        document.getElementById('videosphere').setAttribute('visible', 'true');
        
        // --- LÓGICA DE LOADING ---
        // 1. Mostra o Loading
        document.getElementById('loader-360').setAttribute('visible', 'true');
        // 2. Esconde os controles temporariamente (só aparecem quando começar a tocar)
        document.getElementById('controle-360-gaze').setAttribute('visible', 'false');
        
        document.getElementById('btnPlay360').classList.add('clicavel');
        document.getElementById('btnVoltar360').classList.add('clicavel');

        // Tenta dar play (os eventos definidos em setupVideoEvents cuidarão do resto)
        videoEl.play().catch(e => console.log("Aguardando interação do usuário ou carregamento..."));
    }

    function desativarModo360() {
        const esfera = document.getElementById('videosphere');
        if (esfera.getAttribute('visible') == false) return; 

        pararTudo();
        esfera.setAttribute('visible', 'false');
        document.getElementById('controle-360-gaze').setAttribute('visible', 'false');
        document.getElementById('loader-360').setAttribute('visible', 'false'); // Garante que loading some
        
        document.getElementById('btnPlay360').classList.remove('clicavel');
        document.getElementById('btnVoltar360').classList.remove('clicavel');
    }

    function sairDo360() {
        desativarModo360();
        irPara('grupo-categorias');
    }

    function atualizarAmbiente(idGrupo) {
        if(document.getElementById('videosphere').getAttribute('visible') == true) return;
        const el = document.getElementById('ambiente-3d');
        let preset = 'forest';
        if(idGrupo === 'grupo-cidades') preset = 'arches'; 
        if(idGrupo === 'grupo-categorias') preset = 'volcano';
        if(idGrupo === 'grupo-player') preset = 'starry';
        el.setAttribute('environment', { preset: preset, grid: 'cross', playArea: 1 });
    }

    function pararTudo() {
      const v = document.getElementById('video-player');
      v.pause();
      if(audioNarracao) { audioNarracao.pause(); }
    }
    
    function togglePlay2D() {
       if(audioNarracao) {
         if(audioNarracao.paused) audioNarracao.play(); else audioNarracao.pause();
       }
    }
  </script>
</head>
<body>

  <a-scene>

    <a-assets>
       <video 
         id="video-player" 
         loop 
         crossorigin="anonymous" 
         playsinline 
         webkit-playsinline>
       </video>
    </a-assets>

    <a-entity id="ambiente-3d"></a-entity>
    <a-videosphere id="videosphere" src="#video-player" visible="false" rotation="0 -90 0"></a-videosphere>

    <a-camera>
       <a-cursor id="cursor" color="yellow" fuse="true" fuse-timeout="1500" raycaster="objects: .clicavel" 
         animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
         animation__mouseleave="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 500">
       </a-cursor>

        <a-entity id="loader-360" visible="false" position="0 0 -2">
            <a-text value="CARREGANDO VIDEO..." color="yellow" align="center" width="5"
                    animation="property: opacity; from: 1; to: 0.5; dir: alternate; loop: true; dur: 800">
            </a-text>
            <a-plane color="black" opacity="0.7" width="2.5" height="0.5" position="0 0 -0.01"></a-plane>
        </a-entity>
    </a-camera>

    <a-entity id="controle-360-gaze" visible="false" position="0 1.6 -2">
        <a-plane id="btnPlay360" color="#EF2D5E" width="1.5" height="0.5" opacity="0.9">
           <a-text id="btnText360" value="OLHE PARA TOCAR" align="center" width="4"></a-text>
        </a-plane>

        <a-plane id="btnVoltar360" position="0 -0.6 0" width="0.8" height="0.3" color="#444" class="clicavel" onclick="sairDo360()">
            <a-text value="SAIR" align="center" width="4"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-inicio" visible="true">
        <a-text value="Amapa Interativo" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 3 -3" width="10" color="#000000"></a-text>     
        <a-plane position="0 1.6 -3" width="1.5" height="0.6" color="#004d40" class="clicavel interativo" onclick="irPara('grupo-cidades')">
            <a-text value="INICIAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-cidades" visible="false">
        <a-text value="Escolha o Destino" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 3.5 -3" width="8" color="#FFF"></a-text>
        <a-entity id="grade-cidades" position="0 2 -3"></a-entity>
        <a-plane position="0 0.8 -3" width="1" height="0.4" color="#444" class="clicavel interativo" onclick="irPara('grupo-inicio')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-categorias" visible="false">
        <a-text id="titulo-cidade-cat" value="CIDADE" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 3 -3" width="10" color="#FFF" ></a-text>
        <a-plane position="-1.2 2 -3" width="1.2" height="0.8" color="#004d40" class="clicavel interativo" onclick="verConteudo('Historia')">
            <a-text value="Historia (360)" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="0 2 -3" width="1.2" height="0.8" color="#E64A19" class="clicavel interativo" onclick="verConteudo('Cultura')">
            <a-text value="Cultura" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="1.2 2 -3" width="1.2" height="0.8" color="#388E3C" class="clicavel interativo" onclick="verConteudo('Turismo')">
            <a-text value="Turismo" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="1.5 1 -3" width="1" height="0.3" color="#444" class="clicavel interativo" onclick="irPara('grupo-cidades')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-player" visible="false">
        <a-plane position="0 1.5 -3" width="3" height="2.5" color="#111" opacity="0.95"></a-plane>
        <a-text id="vr-titulo" value="TITULO" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 2.5 -2.9" color="#FFD700" width="4"></a-text>
        <a-image id="vr-imagem-screen" width="2" height="1" position="0 1.8 -2.9" visible="false"></a-image>
        <a-entity id="controles-media" position="0 1 -2.9" visible="false">
             <a-circle radius="0.2" color="green" class="interativo" onclick="togglePlay2D()"></a-circle>
             <a-text value="PLAY AUDIO" position="-0.5 -0.3 0"></a-text>
        </a-entity>
        <a-plane position="0 0.15 -2.9" width="1" height="0.25" color="#444" class="clicavel interativo" onclick="irPara('grupo-categorias')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

  </a-scene>
</body>
</html>
