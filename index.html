<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Explora AP - VR Final</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #111;
    }
  </style>
  
  <script>
    /* --- LÓGICA DO SISTEMA --- */
    
    // Banco de Dados
    const db = {
      'vitoria': {
        nome: 'Vitória do Jari',
        conteudos: {
          'historia': { 
            t: 'VÍDEO DA CIDADE', 
            txt: 'Aponte o cursor para o botão PLAY', 
            video: './assets/videos/vitoria.mp4', 
            tipo: 'video' 
          },
          'culinaria': { 
            t: 'HINO MUNICIPAL', 
            txt: 'Aponte o cursor para o botão PLAY', 
            narra: './assets/audios/vitoria.mp3', 
            tipo: 'audio' 
          },
          'mapa': { 
            t: 'BANDEIRA', 
            txt: 'Visualizando bandeira', 
            imagemPainel: './assets/imagens/vitoria.png', 
            tipo: 'imagem' 
          }
        }
      },
      'macapa': { nome: 'Macapá', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponível'} } },
      'santana': { nome: 'Santana', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponível'} } },
      'amapa': { nome: 'Amapá', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponível'} } },
      'mazagao': { nome: 'Mazagão', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponível'} } },
      'oiapoque': { nome: 'Oiapoque', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponível'} } }
    };

    let cidadeAtual = '';
    let audioNarracao = null;
    let tipoMidiaAtual = '';
    let videoEl = null;
    let cursorEl = null;

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Sistema VR inicializado');
      
      videoEl = document.getElementById('video-player');
      cursorEl = document.getElementById('cursor');
      
      // Configurar eventos do vídeo
      videoEl.addEventListener('loadeddata', function() {
        console.log('Vídeo carregado com sucesso');
        document.getElementById('vr-texto').setAttribute('value', 'Pronto! Aponte para PLAY');
      });
      
      videoEl.addEventListener('error', function(e) {
        console.error('Erro ao carregar vídeo:', e);
        document.getElementById('vr-texto').setAttribute('value', 'Carregando vídeo de demonstração...');
        
        // Usar vídeo de teste online
        setTimeout(() => {
          videoEl.setAttribute('src', 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4');
          videoEl.load();
        }, 1000);
      });
      
      videoEl.addEventListener('play', function() {
        console.log('Vídeo começou a tocar');
        document.getElementById('vr-texto').setAttribute('value', 'Vídeo em reprodução');
      });
      
      // Inicializar depois que o A-Frame carregar
      setTimeout(gerarMenuCidades, 1000);
    });

    // Gera os botões flutuantes das cidades
    function gerarMenuCidades() {
      const container = document.getElementById('grade-cidades');
      const chaves = Object.keys(db);
      
      let col = 0; 
      let row = 0;
      const chavesPorLinha = 3;

      chaves.forEach((chave) => {
        const cidade = db[chave];
        
        const x = (col * 1.1) - 1.1;
        const y = 1.5 - (row * 0.6);
        
        const el = document.createElement('a-entity');
        el.setAttribute('position', `${x} ${y} 0`);
        
        el.innerHTML = `
          <a-plane 
            color="#FFD700" 
            width="1" height="0.4" 
            class="clickable"
            data-action="selectCity"
            data-city="${chave}"
            animation__hover="property: scale; to: 1.1 1.1 1; dur: 200; startEvents: mouseenter"
            animation__unhover="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
             <a-text value="${cidade.nome}" align="center" color="#333" width="2.8" z-offset="0.01"></a-text>
          </a-plane>
        `;
        container.appendChild(el);

        col++;
        if (col >= chavesPorLinha) { 
          col = 0; 
          row++; 
        }
      });
    }

    // --- SISTEMA DE NAVEGAÇÃO ---
    function irPara(idGrupo) {
      console.log('Navegando para:', idGrupo);
      
      const grupos = ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'];
      
      grupos.forEach(g => {
        const el = document.getElementById(g);
        el.setAttribute('visible', 'false');
      });

      const destino = document.getElementById(idGrupo);
      destino.setAttribute('visible', 'true');

      if(idGrupo !== 'grupo-player') {
        pararTudo();
      }
    }

    function selecionarCidade(chave) {
      cidadeAtual = chave;
      console.log('Cidade selecionada:', cidadeAtual);
      document.getElementById('titulo-cidade-cat').setAttribute('value', db[chave].nome);
      irPara('grupo-categorias');
    }

    // --- LÓGICA DE MÍDIA ---
    function verConteudo(tipo) {
      console.log('Carregando conteúdo:', tipo, 'para', cidadeAtual);
      
      if(!db[cidadeAtual] || !db[cidadeAtual].conteudos[tipo]) {
        console.error('Conteúdo não encontrado');
        return;
      }

      const dados = db[cidadeAtual].conteudos[tipo];
      
      const telaVideo = document.getElementById('vr-video-screen');
      const imgPainel = document.getElementById('vr-imagem-screen');
      const controles = document.getElementById('controles-media');
      const titulo = document.getElementById('vr-titulo');
      const texto = document.getElementById('vr-texto');

      // Reset visível
      telaVideo.setAttribute('visible', 'false');
      imgPainel.setAttribute('visible', 'false');
      controles.setAttribute('visible', 'false');
      
      titulo.setAttribute('value', dados.t);
      texto.setAttribute('value', 'Carregando conteúdo...');
      
      pararTudo();

      // É VIDEO?
      if (dados.tipo === 'video' && dados.video) {
        tipoMidiaAtual = 'video';
        console.log('Carregando vídeo:', dados.video);
        
        // Primeiro tenta o vídeo local
        videoEl.setAttribute('src', dados.video);
        videoEl.load();
        
        telaVideo.setAttribute('visible', 'true');
        controles.setAttribute('visible', 'true');
        
        document.getElementById('btn-play-cor').setAttribute('color', '#00FF00'); // Verde brilhante
        document.getElementById('btn-play-txt').setAttribute('value', 'PLAY');
        document.getElementById('btn-play-txt').setAttribute('color', '#000000'); // Texto preto
        
        // Feedback visual para o botão
        const btnPlay = document.querySelector('[data-action="playPause"]');
        if (btnPlay) {
          btnPlay.setAttribute('material', 'color', '#00FF00');
        }
      }
      // É AUDIO?
      else if (dados.tipo === 'audio' && dados.narra) {
        tipoMidiaAtual = 'audio';
        console.log('Carregando áudio:', dados.narra);
        
        try {
          audioNarracao = new Audio(dados.narra);
          audioNarracao.preload = 'auto';
          texto.setAttribute('value', 'Áudio carregado. Aponte para PLAY');
        } catch (e) {
          console.error('Erro ao criar áudio:', e);
          texto.setAttribute('value', 'Erro no áudio');
        }
        
        controles.setAttribute('visible', 'true');
        
        document.getElementById('btn-play-cor').setAttribute('color', '#00FF00');
        document.getElementById('btn-play-txt').setAttribute('value', 'PLAY');
      }
      // É IMAGEM?
      else if (dados.tipo === 'imagem' && dados.imagemPainel) {
        tipoMidiaAtual = 'imagem';
        console.log('Carregando imagem:', dados.imagemPainel);
        
        imgPainel.setAttribute('src', dados.imagemPainel);
        imgPainel.setAttribute('visible', 'true');
        texto.setAttribute('value', dados.txt);
      }

      irPara('grupo-player');
    }

    function togglePlay() {
      console.log('Botão PLAY clicado!');
      console.log('Tipo de mídia:', tipoMidiaAtual);
      console.log('Vídeo pausado?', videoEl.paused);
      
      const btnCor = document.getElementById('btn-play-cor');
      const btnTxt = document.getElementById('btn-play-txt');
      const texto = document.getElementById('vr-texto');

      if (tipoMidiaAtual === 'video') {
        // Verificar se o vídeo tem source
        if (!videoEl.src) {
          console.log('Vídeo sem source, tentando fallback...');
          texto.setAttribute('value', 'Carregando vídeo de demonstração...');
          videoEl.setAttribute('src', 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4');
          videoEl.load();
          
          setTimeout(() => {
            if (videoEl.readyState >= 2) { // HAVE_CURRENT_DATA
              videoEl.play().then(() => {
                btnCor.setAttribute('color', '#FF0000'); // Vermelho
                btnTxt.setAttribute('value', 'PAUSE');
                texto.setAttribute('value', 'Vídeo em reprodução');
              }).catch(e => {
                console.error('Erro ao reproduzir:', e);
                texto.setAttribute('value', 'Clique em PLAY novamente');
              });
            }
          }, 1000);
          return;
        }
        
        if (videoEl.paused) {
          console.log('Tentando reproduzir vídeo...');
          texto.setAttribute('value', 'Iniciando...');
          
          videoEl.play().then(() => {
            console.log('Vídeo começou a tocar!');
            btnCor.setAttribute('color', '#FF0000'); // Vermelho
            btnTxt.setAttribute('value', 'PAUSE');
            texto.setAttribute('value', 'Vídeo em reprodução');
          }).catch(error => {
            console.error('Erro na reprodução:', error);
            
            // Tentar com muted primeiro (política de autoplay)
            if (error.name === 'NotAllowedError') {
              texto.setAttribute('value', 'Ativando som...');
              videoEl.muted = true;
              videoEl.play().then(() => {
                // Agora tentar com som
                setTimeout(() => {
                  videoEl.muted = false;
                  btnCor.setAttribute('color', '#FF0000');
                  btnTxt.setAttribute('value', 'PAUSE');
                  texto.setAttribute('value', 'Vídeo em reprodução');
                }, 1000);
              }).catch(e2 => {
                console.error('Erro mesmo com muted:', e2);
                texto.setAttribute('value', 'Clique novamente para PLAY');
              });
            }
          });
        } else {
          console.log('Pausando vídeo...');
          videoEl.pause();
          btnCor.setAttribute('color', '#00FF00'); // Verde
          btnTxt.setAttribute('value', 'PLAY');
          texto.setAttribute('value', 'Vídeo pausado');
        }
      }
      else if (tipoMidiaAtual === 'audio' && audioNarracao) {
        if (audioNarracao.paused) {
          audioNarracao.play().then(() => {
            btnCor.setAttribute('color', '#FF0000');
            btnTxt.setAttribute('value', 'PAUSE');
            texto.setAttribute('value', 'Áudio em reprodução');
          }).catch(error => {
            console.error('Erro no áudio:', error);
            texto.setAttribute('value', 'Erro ao reproduzir áudio');
          });
        } else {
          audioNarracao.pause();
          btnCor.setAttribute('color', '#00FF00');
          btnTxt.setAttribute('value', 'PLAY');
          texto.setAttribute('value', 'Áudio pausado');
        }
      } else {
        console.log('Nenhuma mídia para tocar');
        texto.setAttribute('value', 'Nenhuma mídia carregada');
      }
    }

    function restartMedia() {
      console.log('Reiniciando mídia...');
      
      const texto = document.getElementById('vr-texto');

      if (tipoMidiaAtual === 'video' && videoEl.src) {
        videoEl.currentTime = 0;
        
        if (videoEl.paused) {
          videoEl.play().then(() => {
            document.getElementById('btn-play-cor').setAttribute('color', '#FF0000');
            document.getElementById('btn-play-txt').setAttribute('value', 'PAUSE');
            texto.setAttribute('value', 'Vídeo reiniciado');
          }).catch(e => {
            console.error('Erro ao reiniciar:', e);
          });
        } else {
          texto.setAttribute('value', 'Vídeo já está tocando');
        }
      }
      else if (tipoMidiaAtual === 'audio' && audioNarracao) {
        audioNarracao.currentTime = 0;
        audioNarracao.play().then(() => {
          document.getElementById('btn-play-cor').setAttribute('color', '#FF0000');
          document.getElementById('btn-play-txt').setAttribute('value', 'PAUSE');
          texto.setAttribute('value', 'Áudio reiniciado');
        });
      }
    }

    function pararTudo() {
      console.log('Parando toda mídia...');
      
      if (videoEl) {
        videoEl.pause();
        videoEl.currentTime = 0;
        // NÃO remover o src!
      }
      
      if (audioNarracao) {
        audioNarracao.pause();
        audioNarracao.currentTime = 0;
        audioNarracao = null;
      }
      
      tipoMidiaAtual = '';
    }

    // Adicionar evento de clique ao documento para debug
    document.addEventListener('click', function(e) {
      console.log('Clique na página:', e.target);
    });

  </script>
</head>
<body>

  <a-scene background="color: #111" cursor="rayOrigin: mouse">
    
    <a-assets>
       <video id="video-player" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <!-- Câmera com cursor simplificado -->
    <a-entity camera look-controls position="0 1.6 0">
      <a-entity 
        cursor="fuse: true; fuseTimeout: 500"
        position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
        material="color: #FFD700; shader: flat"
        raycaster="objects: .clickable, [data-action]">
      </a-entity>
    </a-entity>


    <a-entity id="grupo-inicio" visible="true">
        <a-text value="EXPLORA AP" align="center" position="0 2.5 -3" width="10" color="#FFD700"></a-text>
        <a-text value="Patrimônio Cultural em VR" align="center" position="0 2 -3" width="5" color="white"></a-text>
        
        <a-plane position="0 1 -3" width="1.5" height="0.6" color="#004d40" class="clickable" onclick="irPara('grupo-cidades')">
            <a-text value="INICIAR" align="center" width="6" color="white"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-cidades" visible="false">
        <a-text value="ESCOLHA O DESTINO" align="center" position="0 2.8 -3" width="8" color="#FFD700"></a-text>
        
        <a-entity id="grade-cidades" position="0 0.5 -3"></a-entity>

        <a-plane position="0 -1.2 -3" width="1" height="0.4" color="#444" class="clickable" onclick="irPara('grupo-inicio')">
            <a-text value="VOLTAR" align="center" color="white"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-categorias" visible="false">
        <a-text id="titulo-cidade-cat" value="CIDADE" align="center" position="0 2.5 -3" width="10" color="#FFD700"></a-text>

        <a-plane position="-1.2 1 -3" width="1" height="1" color="#004d40" class="clickable" onclick="verConteudo('historia')">
            <a-text value="VÍDEO" align="center" width="6" color="white"></a-text>
        </a-plane>

        <a-plane position="0 1 -3" width="1" height="1" color="#E64A19" class="clickable" onclick="verConteudo('culinaria')">
            <a-text value="HINO" align="center" width="6" color="white"></a-text>
        </a-plane>

        <a-plane position="1.2 1 -3" width="1" height="1" color="#388E3C" class="clickable" onclick="verConteudo('mapa')">
            <a-text value="BANDEIRA" align="center" width="6" color="white"></a-text>
        </a-plane>

        <a-plane position="0 -0.5 -3" width="1" height="0.3" color="#444" class="clickable" onclick="irPara('grupo-cidades')">
            <a-text value="VOLTAR" align="center" color="white"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-player" visible="false">
        
        <a-plane position="0 1.6 -3" width="3.5" height="2.5" color="#111" opacity="0.95"></a-plane>
        
        <a-text id="vr-titulo" value="TÍTULO" align="center" position="0 2.6 -2.9" color="#FFD700" width="6"></a-text>
        <a-text id="vr-texto" value="Aponte o cursor para o botão PLAY" align="center" position="0 0.6 -2.9" width="3.5" color="white"></a-text>

        <a-video id="vr-video-screen" src="#video-player" width="3" height="1.6" position="0 1.6 -2.9" visible="false"></a-video>
        
        <a-image id="vr-imagem-screen" width="2" height="1.4" position="0 1.6 -2.85" visible="false"></a-image>

        <a-entity id="controles-media" position="0 0 -2.9" visible="false">
            
            <!-- Botão PLAY com área de clique maior -->
            <a-entity position="-0.5 0 0" class="clickable" data-action="playPause" onclick="togglePlay()">
               <a-circle id="btn-play-cor" radius="0.3" color="#00FF00" opacity="0.9"
                 animation__hover="property: scale; to: 1.2 1.2 1; dur: 200; startEvents: mouseenter"
                 animation__unhover="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
               </a-circle>
               <a-text id="btn-play-txt" value="PLAY" align="center" position="0 -0.5 0" color="black" width="2"></a-text>
               <!-- Área de clique maior (invisível) -->
               <a-circle radius="0.4" opacity="0" position="0 0 0.01"></a-circle>
            </a-entity>

            <a-entity position="0.5 0 0" class="clickable" onclick="restartMedia()">
               <a-circle radius="0.3" color="#2196F3" opacity="0.9"
                 animation__hover="property: scale; to: 1.2 1.2 1; dur: 200; startEvents: mouseenter"
                 animation__unhover="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
               </a-circle>
               <a-text value="RESTART" align="center" position="0 -0.5 0" color="white" width="2"></a-text>
               <!-- Área de clique maior (invisível) -->
               <a-circle radius="0.4" opacity="0" position="0 0 0.01"></a-circle>
            </a-entity>
        </a-entity>

        <a-plane position="0 -1.2 -3" width="1" height="0.4" color="#444" class="clickable" onclick="irPara('grupo-categorias')">
            <a-text value="VOLTAR" align="center" color="white"></a-text>
        </a-plane>
        
        <!-- Debug visual: mostrar onde o cursor está apontando -->
        <a-entity id="cursor-debug" position="0 0 -2.9" visible="false">
            <a-circle radius="0.05" color="red" opacity="0.5"></a-circle>
        </a-entity>
    </a-entity>

  </a-scene>
  
  <!-- Painel de debug -->
  <div style="position: absolute; bottom: 10px; left: 10px; color: white; font-size: 12px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; z-index: 1000;">
    <h4 style="margin: 0 0 5px 0;">Debug VR</h4>
    <button onclick="debugInfo()" style="margin: 2px; padding: 5px;">Mostrar Info</button>
    <button onclick="testarPlay()" style="margin: 2px; padding: 5px;">Testar Play</button>
    <button onclick="usarVideoOnline()" style="margin: 2px; padding: 5px;">Usar Vídeo Online</button>
    <div id="debug-info" style="margin-top: 5px; font-family: monospace;"></div>
  </div>
  
  <script>
    // Funções de debug
    function debugInfo() {
      const info = document.getElementById('debug-info');
      info.innerHTML = `
        Cidade: ${cidadeAtual || 'Nenhuma'}<br>
        Tipo Mídia: ${tipoMidiaAtual || 'Nenhum'}<br>
        Vídeo src: ${videoEl.src || 'Nenhum'}<br>
        Vídeo paused: ${videoEl.paused}<br>
        Vídeo readyState: ${videoEl.readyState}<br>
        Cursor: ${document.querySelector('a-cursor') ? 'Encontrado' : 'Não encontrado'}
      `;
    }
    
    function testarPlay() {
      console.log('Testando play manualmente...');
      if (videoEl.src) {
        videoEl.play().then(() => {
          console.log('Play manual funcionou!');
          document.getElementById('vr-texto').setAttribute('value', 'Play manual funcionou');
        }).catch(e => {
          console.error('Erro no play manual:', e);
          document.getElementById('vr-texto').setAttribute('value', 'Erro: ' + e.message);
        });
      } else {
        console.log('Sem vídeo para testar');
        document.getElementById('vr-texto').setAttribute('value', 'Sem vídeo para testar');
      }
    }
    
    function usarVideoOnline() {
      console.log('Mudando para vídeo online...');
      videoEl.setAttribute('src', 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4');
      videoEl.load();
      document.getElementById('vr-texto').setAttribute('value', 'Carregando vídeo online...');
    }
    
    // Adicionar evento global de clique para debug
    window.addEventListener('click', function(e) {
      console.log('Clique global detectado:', e.target);
    });
  </script>
</body>
</html>
